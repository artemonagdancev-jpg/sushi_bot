<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—É—à—ñ –ë–æ—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 16px;
      margin: 0;
      background: #fff;
      max-width: 500px;
      margin: 0 auto;
    }
    .screen { display: none; }
    .active { display: block; }
    .category-btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      background: #ff6347;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
    }
    .slider img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      margin: 10px 0;
    }
    .qty-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    .qty-btn {
      width: 36px;
      height: 36px;
      border: 1px solid #ccc;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .qty-val {
      min-width: 30px;
      text-align: center;
    }
    .cart-btn {
      width: 100%;
      padding: 10px;
      background: #ffc107;
      color: #212529;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 0;
      cursor: pointer;
    }
    .description {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
    }
    button.back, button.submit, button.clear-cart {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    button.back { background: #6c757d; color: white; }
    button.submit { background: #28a745; color: white; }
    button.clear-cart { background: #dc3545; color: white; }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .cart-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .cart-item-name {
      font-weight: bold;
    }
    .cutlery-controls {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed #ccc;
    }

    h2 { text-align: center; }
  </style>
</head>
<body>

<!-- –ï–∫—Ä–∞–Ω 1: –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó -->
<div id="screen-menu" class="screen active">
  <h2>üçΩÔ∏è –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</h2>
  <button class="category-btn" onclick="loadCategory('sets')">–°–µ—Ç–∏</button>
  <button class="category-btn" onclick="loadCategory('sushi')">–°—É—à—ñ</button>
  <button class="category-btn" onclick="loadCategory('drinks')">–ù–∞–ø–æ—ó</button>
</div>

<!-- –ï–∫—Ä–∞–Ω 2: –°–ª–∞–π–¥–µ—Ä -->
<div id="screen-slider" class="screen">
  <div class="slider">
    <img id="item-image" src="" alt="–°—Ç—Ä–∞–≤–∞">
  </div>
  <div class="qty-controls">
    <button class="qty-btn" onclick="changeTempQty(-1)">‚Äì</button>
    <span class="qty-val" id="temp-qty">1</span>
    <button class="qty-btn" onclick="changeTempQty(1)">+</button>
  </div>
  <div class="controls" style="margin:0;">
    <button class="ctrl-btn" id="prev" onclick="prevItem()">‚óÄ</button>
    <button class="ctrl-btn add-btn" style="background:#17a2b8;color:white;" onclick="addToCartWithQty()">‚úÖ –î–æ–¥–∞—Ç–∏</button>
    <button class="ctrl-btn" id="next" onclick="nextItem()">‚ñ∂</button>
  </div>
  <div class="description">
    <h3 id="item-name"></h3>
    <p><strong id="item-price"></strong></p>
    <p id="item-desc"></p>
  </div>
  <button class="cart-btn" onclick="showCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞ (<span id="cart-count">0</span>)</button>
  <button class="back" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π</button>
</div>

<!-- –ï–∫—Ä–∞–Ω 3: –ö–æ—Ä–∑–∏–Ω–∞ -->
<div id="screen-cart" class="screen">
  <h2>üõí –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
  <div id="cart-items">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>
  
  <div class="cutlery-controls">
    <div>ü•¢ –ü—Ä–∏–±–æ—Ä–∏ (ID 6):</div>
    <div class="qty-controls" style="justify-content:flex-start; margin-top:8px;">
      <button class="qty-btn" onclick="changeCutlery(-1)">‚Äì</button>
      <span class="qty-val" id="cutlery-val">0</span>
      <button class="qty-btn" onclick="changeCutlery(1)">+</button>
      <span style="margin-left:10px;">(–¥–æ–¥–∞—Ç–∫–æ–≤–æ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</span>
    </div>
  </div>

  <button class="clear-cart" onclick="clearCart()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫</button>
  <button class="submit" onclick="showOrderForm()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
  <button class="back" onclick="showScreen('screen-slider')">‚Üê –ù–∞–∑–∞–¥</button>
</div>

<!-- –ï–∫—Ä–∞–Ω 4: –§–æ—Ä–º–∞ -->
<div id="screen-form" class="screen">
  <h2>üì± –í–∞—à—ñ –¥–∞–Ω—ñ</h2>
  <input type="text" id="form-name" placeholder="–í–∞—à–µ —ñ–º‚Äô—è (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)">
  <input type="tel" id="form-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)">
  <textarea id="form-address" placeholder="–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)" rows="2"></textarea>
  <button class="submit" onclick="submitOrder()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
  <button class="back" onclick="showScreen('screen-cart')">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∫–æ—Ä–∑–∏–Ω–∏</button>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzssbuflx7nQKsVJ0Vxz1j8qAYIYKCzBWXEyqb4CV6o3WUDftvA4yAjLMSZ2e8tP8a0jQ/exec";
  let currentCategory = [];
  let currentIndex = 0;
  let selectedItem = null;
  let cart = []; // [{id, name, price, qty}, ...]
  let tempQty = 1;
  let cutleryQty = 0; // –ø—Ä–∏–±–æ—Ä–∏ (ID = 6)

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'screen-cart') renderCart();
  }

  function goBack() {
    showScreen('screen-menu');
  }

  function loadCategory(category) {
    fetch(API_URL + "?category=" + category)
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        currentCategory = data;
        currentIndex = 0;
        if (currentCategory.length > 0) {
          showItem(0);
          showScreen('screen-slider');
        } else {
          alert("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è");
        }
      })
      .catch(err => {
        alert("–ü–æ–º–∏–ª–∫–∞: " + err.message);
      });
  }

  function showItem(index) {
    const item = currentCategory[index];
    document.getElementById('item-image').src = item.image || "https://via.placeholder.com/400x300?text=–§–æ—Ç–æ+–≤—ñ–¥—Å—É—Ç–Ω—î";
    document.getElementById('item-name').innerText = item.name || "‚Äî";
    document.getElementById('item-price').innerText = item.price ? item.price + " –≥—Ä–Ω" : "";
    document.getElementById('item-desc').innerText = item.description || "–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π";
    selectedItem = item;
    tempQty = 1;
    document.getElementById('temp-qty').innerText = tempQty;

    document.getElementById('prev').disabled = (index === 0);
    document.getElementById('next').disabled = (index === currentCategory.length - 1);
  }

  function prevItem() {
    if (currentIndex > 0) {
      currentIndex--;
      showItem(currentIndex);
    }
  }

  function nextItem() {
    if (currentIndex < currentCategory.length - 1) {
      currentIndex++;
      showItem(currentIndex);
    }
  }

  function changeTempQty(delta) {
    tempQty = Math.max(1, tempQty + delta);
    document.getElementById('temp-qty').innerText = tempQty;
  }

  function addToCartWithQty() {
    const existing = cart.find(c => c.id === selectedItem.id);
    if (existing) {
      existing.qty += tempQty;
    } else {
      cart.push({
        id: selectedItem.id,
        name: selectedItem.name,
        price: selectedItem.price,
        qty: tempQty
      });
    }
    updateCartBadge();
    Telegram.WebApp?.showAlert(`‚úÖ –î–æ–¥–∞–Ω–æ ${tempQty} —à—Ç:\n${selectedItem.name}`);
    tempQty = 1;
    document.getElementById('temp-qty').innerText = 1;
  }

  function changeCutlery(delta) {
    cutleryQty = Math.max(0, cutleryQty + delta);
    document.getElementById('cutlery-val').innerText = cutleryQty;
  }

  function updateCartBadge() {
    const total = cart.reduce((sum, c) => sum + c.qty, 0) + cutleryQty;
    document.getElementById('cart-count').innerText = total;
  }

  function clearCart() {
    if (confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫?")) {
      cart = [];
      cutleryQty = 0;
      updateCartBadge();
      renderCart();
    }
  }

  function showCart() {
    showScreen('screen-cart');
  }

  function renderCart() {
    if (cart.length === 0 && cutleryQty === 0) {
      document.getElementById('cart-items').innerHTML = "<p>–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>";
      return;
    }

    let html = '';
    cart.forEach(c => {
      html += `
        <div class="cart-item">
          <div class="cart-item-name">${c.name}</div>
          <div>${c.qty} —à—Ç √ó ${c.price} –≥—Ä–Ω = ${c.qty * c.price} –≥—Ä–Ω</div>
        </div>
      `;
    });

    if (cutleryQty > 0) {
      html += `
        <div class="cart-item">
          <div class="cart-item-name">ü•¢ –ü—Ä–∏–±–æ—Ä–∏</div>
          <div>${cutleryQty} —à—Ç √ó 0 –≥—Ä–Ω = 0 –≥—Ä–Ω</div>
        </div>
      `;
    }

    const total = cart.reduce((sum, c) => sum + c.qty * c.price, 0);
    html += `<div style="margin-top:15px; font-weight:bold; font-size:18px;">–†–∞–∑–æ–º: ${total} –≥—Ä–Ω</div>`;

    document.getElementById('cart-items').innerHTML = html;
  }

  function showOrderForm() {
    if (cart.length === 0 && cutleryQty === 0) {
      Telegram.WebApp?.showAlert("–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π!");
      return;
    }
    showScreen('screen-form');
  }

  function submitOrder() {
    const name = document.getElementById('form-name').value.trim();
    const phone = document.getElementById('form-phone').value.trim();
    const address = document.getElementById('form-address').value.trim();

    if (!name || !phone || !address) {
      Telegram.WebApp?.showAlert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è!");
      return;
    }

    // –§–æ—Ä–º—É—î–º–æ items: id1:qty1,id2:qty2,...,6:cutleryQty
    let items = cart.map(c => `${c.id}:${c.qty}`);
    if (cutleryQty > 0) {
      items.push(`6:${cutleryQty}`);
    }
    const itemsStr = items.join(",");

    const url = `${API_URL}?items=${encodeURIComponent(itemsStr)}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&address=${encodeURIComponent(address)}`;

    fetch(url)
      .then(() => {
        cart = [];
        cutleryQty = 0;
        updateCartBadge();
        Telegram.WebApp?.showPopup({
          title: "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ!",
          message: "–î—è–∫—É—î–º–æ! –ú–∏ –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—î–º–æ –≤–∞–º –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º."
        }, () => {
          Telegram.WebApp?.close();
        });
      })
      .catch(err => {
        Telegram.WebApp?.showAlert("–ü–æ–º–∏–ª–∫–∞: " + err.message);
      });
  }
</script>
</body>
</html>
