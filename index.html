<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—É—à—ñ –ë–æ—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 16px;
      margin: 0;
      background: #fff;
      max-width: 500px;
      margin: 0 auto;
    }
    .screen { display: none; }
    .active { display: block; }
    .category-btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      background: #ff6347;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
    }
    .back-to-menu {
      width: 100%;
      padding: 8px;
      background: #e9ecef;
      color: #495057;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .slider img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 12px;
      margin: 10px 0;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    .ctrl-btn {
      padding: 12px 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: #f0f0f0;
      cursor: pointer;
      min-width: 70px;
    }
    .add-btn {
      background: #17a2b8 !important;
      color: white;
      font-weight: bold;
    }
    .cart-btn {
      width: 100%;
      padding: 10px;
      background: #ffc107;
      color: #212529;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      margin: 10px 0;
      cursor: pointer;
    }
    .description {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
    }
    button.submit {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      background: #28a745;
      color: white;
    }
    button.clear-cart {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      background: #dc3545;
      color: white;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .cart-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .cart-item-info {
      flex: 1;
    }
    .cart-item-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .qty-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #ccc;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .qty-val {
      min-width: 28px;
      text-align: center;
    }
    .cutlery-controls {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed #ccc;
    }
    h2 { text-align: center; }
  </style>
</head>
<body>

<!-- –ï–∫—Ä–∞–Ω 1: –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó -->
<div id="screen-menu" class="screen active">
  <h2>üçΩÔ∏è –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</h2>
  <button class="category-btn" onclick="loadCategory('sets')">–°–µ—Ç–∏</button>
  <button class="category-btn" onclick="loadCategory('sushi')">–°—É—à—ñ</button>
  <button class="category-btn" onclick="loadCategory('drinks')">–ù–∞–ø–æ—ó</button>
</div>

<!-- –ï–∫—Ä–∞–Ω 2: –°–ª–∞–π–¥–µ—Ä -->
<div id="screen-slider" class="screen">
  <button class="back-to-menu" onclick="goBack()">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</button>
  <div class="slider">
    <img id="item-image" src="" alt="–°—Ç—Ä–∞–≤–∞">
  </div>
  <div class="controls">
    <button class="ctrl-btn" id="prev" onclick="prevItem()">‚óÄ</button>
    <button class="ctrl-btn add-btn" onclick="addToCart()">‚úÖ –î–æ–¥–∞—Ç–∏</button>
    <button class="ctrl-btn" id="next" onclick="nextItem()">‚ñ∂</button>
  </div>
  <div class="description">
    <h3 id="item-name"></h3>
    <p><strong id="item-price"></strong></p>
    <p id="item-desc"></p>
  </div>
  <button class="cart-btn" onclick="showCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞ (<span id="cart-count">0</span>)</button>
</div>

<!-- –ï–∫—Ä–∞–Ω 3: –ö–æ—Ä–∑–∏–Ω–∞ -->
<div id="screen-cart" class="screen">
  <h2>üõí –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
  <div id="cart-items">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>
  
  <div class="cutlery-controls">
    <div>ü•¢ –ü—Ä–∏–±–æ—Ä–∏ (ID 6):</div>
    <div class="cart-item-controls" style="justify-content:flex-start; margin-top:10px;">
      <button class="qty-btn" onclick="changeCutlery(-1)">‚Äì</button>
      <span class="qty-val" id="cutlery-val">0</span>
      <button class="qty-btn" onclick="changeCutlery(1)">+</button>
      <span style="margin-left:10px;">(–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</span>
    </div>
  </div>

  <button class="submit" onclick="showOrderForm()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
  <button class="clear-cart" onclick="clearCart()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫</button>
  <button class="back-to-menu" onclick="goBack()">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</button>
</div>

<!-- –ï–∫—Ä–∞–Ω 4: –§–æ—Ä–º–∞ -->
<div id="screen-form" class="screen">
  <h2>üì± –í–∞—à—ñ –¥–∞–Ω—ñ</h2>
  <input type="text" id="form-name" placeholder="–í–∞—à–µ —ñ–º‚Äô—è (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)">
  <input type="tel" id="form-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)">
  <textarea id="form-address" placeholder="–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)" rows="2"></textarea>
  <button class="submit" onclick="submitOrder()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
  <button class="back-to-menu" onclick="showScreen('screen-cart')">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∫–æ—Ä–∑–∏–Ω–∏</button>
</div>

<script>
  // üî¥ –¢–í–Ü–ô –ù–û–í–ò–ô URL
  const API_URL = "https://script.google.com/macros/s/AKfycbxBvr_0Nck0V2qrNdswXl78aJ19mn5Wyyp7I0pMppaU8webWNu18dClUEvZOP99bwitbg/exec";

  let currentCategory = [];
  let currentIndex = 0;
  let selectedItem = null;
  let cart = [];
  let cutleryQty = 0;

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'screen-cart') renderCart();
  }

  function goBack() {
    showScreen('screen-menu');
  }

  function loadCategory(category) {
    // –ö–ï–®–£–í–ê–ù–ù–Ø –ú–ï–ù–Æ
    const cacheKey = 'menu_' + category;
    const cacheTimeKey = cacheKey + '_time';
    const cached = localStorage.getItem(cacheKey);
    const lastFetch = localStorage.getItem(cacheTimeKey);

    const now = Date.now();
    if (cached && lastFetch && (now - parseInt(lastFetch)) < 10 * 60 * 1000) {
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–µ—à (10 —Ö–≤–∏–ª–∏–Ω)
      try {
        currentCategory = JSON.parse(cached);
        currentIndex = 0;
        if (currentCategory.length > 0) {
          showItem(0);
          showScreen('screen-slider');
        } else {
          alert("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è");
        }
        return;
      } catch (e) {
        // –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫—É –∫–µ—à—É
      }
    }

    // –ó–∞–ø–∏—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
    fetch(API_URL + "?category=" + category)
      .then(res => {
        if (!res.ok) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î");
        return res.json();
      })
      .then(data => {
        if (data.error) throw new Error(data.error);
        currentCategory = data;
        localStorage.setItem(cacheKey, JSON.stringify(data));
        localStorage.setItem(cacheTimeKey, now.toString());
        currentIndex = 0;
        if (currentCategory.length > 0) {
          showItem(0);
          showScreen('screen-slider');
        } else {
          alert("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è");
        }
      })
      .catch(err => {
        alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–µ–Ω—é: " + err.message);
      });
  }

  function showItem(index) {
    const item = currentCategory[index];
    document.getElementById('item-image').src = item.image || "https://via.placeholder.com/400x300?text=–§–æ—Ç–æ+–≤—ñ–¥—Å—É—Ç–Ω—î";
    document.getElementById('item-name').innerText = item.name || "‚Äî";
    document.getElementById('item-price').innerText = item.price ? item.price + " –≥—Ä–Ω" : "";
    document.getElementById('item-desc').innerText = item.description || "–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π";
    selectedItem = item;
    document.getElementById('prev').disabled = (index === 0);
    document.getElementById('next').disabled = (index === currentCategory.length - 1);
  }

  function prevItem() {
    if (currentIndex > 0) {
      currentIndex--;
      showItem(currentIndex);
    }
  }

  function nextItem() {
    if (currentIndex < currentCategory.length - 1) {
      currentIndex++;
      showItem(currentIndex);
    }
  }

  function addToCart() {
    if (!selectedItem) return;
    const existing = cart.find(c => c.id === selectedItem.id);
    if (existing) {
      existing.qty++;
    } else {
      cart.push({ id: selectedItem.id, name: selectedItem.name, price: selectedItem.price, qty: 1 });
    }
    updateCartBadge();
    Telegram.WebApp?.showAlert(`‚úÖ –î–æ–¥–∞–Ω–æ:\n${selectedItem.name}`);
  }

  function changeCutlery(delta) {
    cutleryQty = Math.max(0, cutleryQty + delta);
    document.getElementById('cutlery-val').innerText = cutleryQty;
    updateCartBadge();
  }

  function updateCartBadge() {
    const total = cart.reduce((sum, c) => sum + c.qty, 0) + cutleryQty;
    document.getElementById('cart-count').innerText = total;
  }

  function clearCart() {
    if (confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫?")) {
      cart = [];
      cutleryQty = 0;
      updateCartBadge();
      renderCart();
    }
  }

  function showCart() {
    showScreen('screen-cart');
  }

  function renderCart() {
    if (cart.length === 0 && cutleryQty === 0) {
      document.getElementById('cart-items').innerHTML = "<p>–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>";
      return;
    }

    let html = '';
    cart.forEach(c => {
      html += `<div class="cart-item">
        <div class="cart-item-info"><div class="cart-item-name">${c.name}</div><div>${c.qty} —à—Ç √ó ${c.price} –≥—Ä–Ω</div></div>
        <div class="cart-item-controls">
          <button class="qty-btn" onclick="changeQty(${c.id}, -1)">‚Äì</button>
          <span class="qty-val">${c.qty}</span>
          <button class="qty-btn" onclick="changeQty(${c.id}, 1)">+</button>
        </div>
      </div>`;
    });

    if (cutleryQty > 0) {
      html += `<div class="cart-item">
        <div class="cart-item-info"><div class="cart-item-name">ü•¢ –ü—Ä–∏–±–æ—Ä–∏</div><div>${cutleryQty} —à—Ç</div></div>
        <div class="cart-item-controls">
          <button class="qty-btn" onclick="changeCutlery(-1)">‚Äì</button>
          <span class="qty-val">${cutleryQty}</span>
          <button class="qty-btn" onclick="changeCutlery(1)">+</button>
        </div>
      </div>`;
    }

    const total = cart.reduce((sum, c) => sum + c.qty * c.price, 0);
    html += `<div style="margin-top:15px; font-weight:bold; font-size:18px;">–†–∞–∑–æ–º: ${total} –≥—Ä–Ω</div>`;
    document.getElementById('cart-items').innerHTML = html;
  }

  function changeQty(id, delta) {
    const item = cart.find(c => c.id === id);
    if (item) {
      item.qty += delta;
      if (item.qty <= 0) cart = cart.filter(c => c.id !== id);
      renderCart();
      updateCartBadge();
    }
  }

  function showOrderForm() {
    if (cart.length === 0 && cutleryQty === 0) {
      Telegram.WebApp?.showAlert("–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π!");
      return;
    }
    showScreen('screen-form');
  }

  function submitOrder() {
    const name = document.getElementById('form-name').value.trim();
    const phone = document.getElementById('form-phone').value.trim();
    const address = document.getElementById('form-address').value.trim();

    if (!name || !phone || !address) {
      Telegram.WebApp?.showAlert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è!");
      return;
    }

    let items = cart.map(c => `${c.id}:${c.qty}`);
    if (cutleryQty > 0) items.push(`6:${cutleryQty}`);
    const itemsStr = items.join(",");

    const url = `${API_URL}?items=${encodeURIComponent(itemsStr)}&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&address=${encodeURIComponent(address)}`;
    window.location.href = url;
  }
</script>
</body>
</html>
